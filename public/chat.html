<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, interactive-widget=resizes-content">
    <title>Xat - Sistema de Missatgeria</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <link rel="stylesheet" href="styles/custom.css">
</head>
<body>
    <div id="loginContainer" class="vh-100-dynamic d-flex justify-content-center align-items-center chat-login-gradient" style="display: none !important;">
        <div class="container">
            <div class="row justify-content-center">
                <div class="col-11 col-sm-10 col-md-8 col-lg-6 col-xl-5 col-xxl-4">
                    <div class="card shadow-lg border-0">
                        <div class="card-body p-4 p-md-5">
                            <h2 class="card-title fs-4 fw-semibold text-dark mb-3">Iniciar Sessi贸</h2>
                            <div class="alert alert-light border-start border-3 border-primary mb-4" role="alert">
                                <small class="d-block lh-base">
                                    <strong>Usuaris:</strong> professor@example.com, alumne@example.com, empresari@example.com<br>
                                    <strong>Contrasenya:</strong> password123
                                </small>
                            </div>
                            <form onsubmit="event.preventDefault(); login();">
                                <div class="mb-3">
                                    <input type="email" id="emailInput" class="form-control form-control-lg" placeholder="Correu" value="professor@example.com" required>
                                </div>
                                <div class="mb-4">
                                    <input type="password" id="passwordInput" class="form-control form-control-lg" placeholder="Contrasenya" value="password123" required>
                                </div>
                                <button type="submit" class="btn btn-lg w-100 fw-semibold" style="background-color: var(--chat-purple); border-color: var(--chat-purple); color: white;">Iniciar Sessi贸</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="chatContainer" class="vh-100-dynamic d-flex flex-column" style="display: none !important;">
        <nav class="navbar navbar-light bg-white border-bottom shadow-sm">
            <div class="container-fluid px-3 px-md-4">
                <div class="d-flex align-items-center gap-2">
                    <span class="navbar-text fw-semibold text-dark mb-0" id="userName"></span>
                    <span class="badge rounded-pill" style="background-color: #f0f2f5; color: #666; font-size: 0.75rem;" id="userRole"></span>
                </div>
            </div>
        </nav>

        <div class="container-fluid flex-grow-1 overflow-hidden p-0">
            <div class="row g-0 h-100" id="mainContainer">
            <div class="col-12 col-md-5 col-lg-4 col-xl-3 d-flex flex-column border-end bg-white" id="sidebar">
                <div class="bg-light border-bottom p-3">
                    <h6 class="fw-bold text-dark mb-0">Xats</h6>
                </div>
                <div class="overflow-auto flex-grow-1 custom-scrollbar" id="usersList"></div>
            </div>

            <div class="col-12 col-md-7 col-lg-8 col-xl-9 d-flex flex-column" id="chatArea">
                <div id="emptyState" class="d-flex flex-column justify-content-center align-items-center h-100 bg-light text-center p-4">
                    <div class="empty-state-icon mb-3"></div>
                    <div class="fs-5 fw-medium text-muted mb-2">Cap conversa seleccionada</div>
                    <div class="text-muted small">Selecciona un xat o contacte de la llista per comen莽ar a conversar</div>
                </div>

                <div id="chatView" class="d-none flex-column h-100">
                    <div class="bg-white border-bottom p-3 d-flex align-items-center gap-2">
                        <button type="button" class="btn btn-link text-decoration-none p-0 d-md-none" style="color: var(--chat-purple); font-size: 1.375rem; font-weight: 700;" id="backBtn" onclick="showSidebar()">&#8592;</button>
                        <div class="fw-semibold text-dark" id="chatTitle"></div>
                    </div>

                    <div class="flex-grow-1 overflow-auto p-3 chat-messages-bg custom-scrollbar" id="messagesContainer"></div>

                    <div id="filePreviewContainer"></div>

                    <div class="bg-white border-top p-3 d-flex gap-2 align-items-center safe-area-bottom" id="messageInputContainer">
                        <input type="file" id="fileInput" class="d-none" onchange="handleFileSelect(event)">
                        <button type="button" id="attachBtn" onclick="document.getElementById('fileInput').click()"></button>
                        <input type="text" id="messageInput" class="form-control rounded-pill border-secondary" placeholder="Escriu un missatge..." onkeypress="if(event.key==='Enter') sendMessage()">
                        <button type="button" class="btn rounded-pill px-4 fw-semibold" style="background-color: var(--chat-purple); border-color: var(--chat-purple); color: white;" id="sendBtn" onclick="sendMessage()">Enviar</button>
                    </div>
                </div>
            </div>
            </div>
        </div>
    </div>


    <script>
        const API_URL = '/api';
        let token = localStorage.getItem('token');
        let currentUser = null;
        let currentConversation = null;
        let currentChatUser = null;
        let allUsers = [];
        let messageInterval = null;
        let sidebarInterval = null;
        let selectedFile = null;

        const userColors = ['#667eea','#e74c3c','#2ecc71','#e67e22','#9b59b6','#1abc9c','#f39c12','#3498db'];
        function getUserColor(id) {
            return userColors[id % userColors.length];
        }

        function isMobile() {
            return window.innerWidth <= 768;
        }

        function showSidebar() {
            if (!isMobile()) return;
            const sidebar = document.getElementById('sidebar');
            const chatArea = document.getElementById('chatArea');
            sidebar.classList.remove('d-none');
            sidebar.classList.add('d-flex');
            chatArea.classList.add('d-none');
            chatArea.classList.remove('d-flex');
        }

        function showChatArea() {
            if (!isMobile()) return;
            const sidebar = document.getElementById('sidebar');
            const chatArea = document.getElementById('chatArea');
            sidebar.classList.add('d-none');
            sidebar.classList.remove('d-flex');
            chatArea.classList.remove('d-none');
            chatArea.classList.add('d-flex');
        }

        function initMobileState() {
            const sidebar = document.getElementById('sidebar');
            const chatArea = document.getElementById('chatArea');
            if (isMobile()) {
                sidebar.classList.remove('d-none');
                sidebar.classList.add('d-flex');
                chatArea.classList.add('d-none');
                chatArea.classList.remove('d-flex');
            } else {
                sidebar.classList.remove('d-none');
                sidebar.classList.add('d-flex');
                chatArea.classList.remove('d-none');
                chatArea.classList.add('d-flex');
            }
        }

        window.addEventListener('resize', () => {
            const chatContainer = document.getElementById('chatContainer');
            if (!chatContainer || chatContainer.classList.contains('d-none')) return;
            if (!isMobile()) {
                const sidebar = document.getElementById('sidebar');
                const chatArea = document.getElementById('chatArea');
                sidebar.classList.remove('d-none');
                sidebar.classList.add('d-flex');
                chatArea.classList.remove('d-none');
                chatArea.classList.add('d-flex');
            }
        });

        if (token) {
            checkAuth();
        } else {
            document.getElementById('loginContainer').style.display = 'flex';
            document.getElementById('loginContainer').classList.remove('d-none');
        }

        async function login() {
            const email = document.getElementById('emailInput').value;
            const password = document.getElementById('passwordInput').value;

            try {
                const response = await fetch(`${API_URL}/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });

                const data = await response.json();

                if (response.ok) {
                    token = data.token;
                    currentUser = data.user;
                    localStorage.setItem('token', token);
                    showChat();
                } else {
                    alert('Error al iniciar sessi贸');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error de connexi贸');
            }
        }

        async function checkAuth() {
            try {
                const response = await fetch(`${API_URL}/me`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Accept': 'application/json'
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    currentUser = data.user;
                    showChat();
                } else {
                    logout();
                }
            } catch (error) {
                logout();
            }
        }

        function showChat() {
            document.getElementById('loginContainer').style.display = 'none';
            document.getElementById('loginContainer').classList.add('d-none');
            document.getElementById('chatContainer').style.display = 'flex';
            document.getElementById('chatContainer').classList.remove('d-none');
            document.getElementById('userName').textContent = currentUser.name;
            document.getElementById('userRole').textContent = currentUser.role;

            initMobileState();
            loadUsersAndConversations();

            if (sidebarInterval) clearInterval(sidebarInterval);
            sidebarInterval = setInterval(loadUsersAndConversations, 3000);
        }

        async function loadUsersAndConversations() {
            try {
                const [usersResponse, conversationsResponse] = await Promise.all([
                    fetch(`${API_URL}/users`, {
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Accept': 'application/json'
                        }
                    }),
                    fetch(`${API_URL}/conversations`, {
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Accept': 'application/json'
                        }
                    })
                ]);

                const usersData = await usersResponse.json();
                const conversationsData = await conversationsResponse.json();

                allUsers = usersData.users;
                const container = document.getElementById('usersList');
                container.innerHTML = '';

                const privateConversations = new Map();
                conversationsData.conversations
                    .filter(conv => conv.conversation.private)
                    .forEach(conv => {
                        const otherParticipant = conv.conversation.participants.find(
                            p => p.messageable_id !== currentUser.id
                        );
                        if (otherParticipant) {
                            privateConversations.set(otherParticipant.messageable_id, {
                                unread_count: conv.unread_count || 0,
                                last_message: conv.last_message || null
                            });
                        }
                    });

                conversationsData.conversations
                    .filter(conv => !conv.conversation.private)
                    .forEach(conv => {
                        const div = document.createElement('a');
                        div.className = 'list-group-item list-group-item-action border-0 border-bottom d-flex align-items-center gap-3 position-relative py-3 ps-4';
                        div.id = `conv-${conv.conversation.id}`;
                        div.href = '#';
                        div.style.cursor = 'pointer';

                        if (currentConversation === conv.conversation.id) {
                            div.classList.add('active');
                        }

                        const unreadBadge = (conv.unread_count && conv.unread_count > 0)
                            ? `<span class="badge badge-unread rounded-pill position-absolute end-0 me-3">${conv.unread_count}</span>`
                            : '';

                        const lastMsg = conv.last_message;
                        const lastMsgHtml = lastMsg && lastMsg.body
                            ? `<div class="small text-muted text-truncate" style="max-width: 220px;"><strong>${lastMsg.sender_name}:</strong> ${escapeHtml(lastMsg.body)}</div>`
                            : lastMsg && !lastMsg.body
                            ? `<div class="small text-muted text-truncate" style="max-width: 220px;"><strong>${lastMsg.sender_name}:</strong>  Fitxer</div>`
                            : '';

                        div.innerHTML = `
                            <div class="user-avatar flex-shrink-0" style="background: #4caf50;"></div>
                            <div class="flex-grow-1 min-width-0">
                                <div class="fw-semibold text-dark mb-1">${conv.conversation.name || 'Grup'} <span class="badge bg-light text-muted small">Grup</span></div>
                                ${lastMsgHtml}
                            </div>
                            ${unreadBadge}
                        `;
                        div.onclick = (e) => {
                            e.preventDefault();
                            openConversation(conv.conversation);
                        };
                        container.appendChild(div);
                    });

                usersData.users.forEach(user => {
                    const div = document.createElement('a');
                    div.className = 'list-group-item list-group-item-action border-0 border-bottom d-flex align-items-center gap-3 position-relative py-3 ps-4';
                    div.id = `user-${user.id}`;
                    div.href = '#';
                    div.style.cursor = 'pointer';

                    if (currentChatUser && currentChatUser.id === user.id) {
                        div.classList.add('active');
                    }

                    const initials = user.name.split(' ').map(n => n[0]).join('').toUpperCase();
                    const colorIndex = user.id % 8;
                    const privData = privateConversations.get(user.id);
                    const unreadCount = privData ? privData.unread_count : 0;
                    const unreadBadge = unreadCount > 0
                        ? `<span class="badge badge-unread rounded-pill position-absolute end-0 me-3">${unreadCount}</span>`
                        : '';

                    const privLastMsg = privData ? privData.last_message : null;
                    const privLastMsgHtml = privLastMsg && privLastMsg.body
                        ? `<div class="small text-muted text-truncate" style="max-width: 220px;">${escapeHtml(privLastMsg.body)}</div>`
                        : privLastMsg && !privLastMsg.body
                        ? `<div class="small text-muted text-truncate" style="max-width: 220px;"> Fitxer</div>`
                        : '';

                    div.innerHTML = `
                        <div class="user-avatar flex-shrink-0" data-color="${colorIndex}">${initials}</div>
                        <div class="flex-grow-1 min-width-0">
                            <div class="fw-semibold text-dark mb-1">${user.name} <span class="badge bg-light text-muted small">${user.role}</span></div>
                            ${privLastMsgHtml}
                        </div>
                        ${unreadBadge}
                    `;
                    div.onclick = (e) => {
                        e.preventDefault();
                        openChatWithUser(user);
                    };
                    container.appendChild(div);
                });
            } catch (error) {
                console.error('Error:', error);
            }
        }

        async function openConversation(conversation) {
            if (messageInterval) {
                clearInterval(messageInterval);
            }

            document.querySelectorAll('.list-group-item').forEach(item => item.classList.remove('active'));
            const convElement = document.getElementById(`conv-${conversation.id}`);
            if (convElement) convElement.classList.add('active');

            currentChatUser = null;
            currentConversation = conversation.id;

            document.getElementById('emptyState').classList.add('d-none');
            document.getElementById('chatView').classList.remove('d-none');
            document.getElementById('chatView').classList.add('d-flex');
            document.getElementById('chatTitle').textContent = conversation.name || 'Grup';
            showChatArea();

            await loadMessages();

            loadUsersAndConversations();

            messageInterval = setInterval(loadMessages, 3000);
        }

        async function openChatWithUser(user) {
            if (messageInterval) {
                clearInterval(messageInterval);
            }

            document.querySelectorAll('.list-group-item').forEach(item => item.classList.remove('active'));
            const userElement = document.getElementById(`user-${user.id}`);
            if (userElement) userElement.classList.add('active');

            currentChatUser = user;

            document.getElementById('emptyState').classList.add('d-none');
            document.getElementById('chatView').classList.remove('d-none');
            document.getElementById('chatView').classList.add('d-flex');
            document.getElementById('chatTitle').textContent = user.name;
            document.getElementById('messagesContainer').innerHTML = '<div class="text-center text-muted">Carregant...</div>';
            showChatArea();

            try {
                const response = await fetch(`${API_URL}/conversations/private`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({ user_id: user.id })
                });

                const data = await response.json();
                currentConversation = data.conversation.id;

                await loadMessages();

                loadUsersAndConversations();

                messageInterval = setInterval(loadMessages, 3000);
            } catch (error) {
                console.error('Error:', error);
                alert('Error al obrir el xat');
            }
        }

        async function loadMessages() {
            if (!currentConversation) return;

            try {
                const response = await fetch(`${API_URL}/conversations/${currentConversation}/messages`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Accept': 'application/json'
                    }
                });

                const data = await response.json();
                const container = document.getElementById('messagesContainer');
                const wasAtBottom = container.scrollHeight - container.scrollTop === container.clientHeight;

                container.innerHTML = '';

                if (!data.messages || data.messages.length === 0) {
                    container.innerHTML = '<div class="text-center text-muted p-4">Cap missatge. Comen莽a la conversa!</div>';
                } else {
                    data.messages.forEach(msg => {
                        const isSent = msg.sender.id === currentUser.id;

                        const wrapper = document.createElement('div');
                        wrapper.className = `d-flex mb-3 ${isSent ? 'justify-content-end' : 'justify-content-start'}`;

                        const card = document.createElement('div');
                        card.className = `card border-0 shadow-sm ${isSent ? 'message-bubble-sent' : 'message-bubble-received'}`;
                        card.style.maxWidth = '75%';

                        const cardBody = document.createElement('div');
                        cardBody.className = 'card-body p-2 px-3';

                        if (!isSent) {
                            const senderDiv = document.createElement('div');
                            senderDiv.className = 'small fw-semibold mb-1';
                            senderDiv.style.color = getUserColor(msg.sender.id);
                            senderDiv.textContent = msg.sender.name;
                            cardBody.appendChild(senderDiv);
                        }

                        if (msg.data && msg.data.url) {
                            const fileDiv = document.createElement('div');
                            fileDiv.className = 'message-file mb-2';

                            if (msg.data.mime_type && msg.data.mime_type.startsWith('image/')) {
                                const img = document.createElement('img');
                                img.src = msg.data.url;
                                img.alt = msg.data.original_name;
                                img.className = 'img-fluid rounded cursor-pointer';
                                img.style.maxWidth = '300px';
                                img.onclick = () => window.open(msg.data.url, '_blank');
                                fileDiv.appendChild(img);
                            } else if (msg.data.mime_type && msg.data.mime_type.startsWith('video/')) {
                                const video = document.createElement('video');
                                video.src = msg.data.url;
                                video.controls = true;
                                video.className = 'rounded';
                                video.style.maxWidth = '300px';
                                fileDiv.appendChild(video);
                            } else {
                                const link = document.createElement('a');
                                link.href = msg.data.url;
                                link.target = '_blank';
                                link.download = msg.data.original_name;
                                link.className = 'text-decoration-none';
                                link.innerHTML = `
                                    <div class="d-inline-flex align-items-center gap-2 p-2 px-3 bg-light rounded">
                                        <span></span>
                                        <span class="small">${escapeHtml(msg.data.original_name)}</span>
                                    </div>
                                `;
                                fileDiv.appendChild(link);
                            }
                            cardBody.appendChild(fileDiv);
                        }

                        if (msg.body) {
                            const textDiv = document.createElement('div');
                            textDiv.className = 'mb-1';
                            textDiv.textContent = msg.body;
                            cardBody.appendChild(textDiv);
                        }

                        const timeDiv = document.createElement('div');
                        timeDiv.className = 'small text-muted mt-1';
                        timeDiv.style.fontSize = '0.6875rem';
                        timeDiv.textContent = new Date(msg.created_at).toLocaleString();
                        cardBody.appendChild(timeDiv);

                        card.appendChild(cardBody);
                        wrapper.appendChild(card);
                        container.appendChild(wrapper);
                    });
                }

                if (wasAtBottom || container.children.length === 1) {
                    container.scrollTop = container.scrollHeight;
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            selectedFile = file;

            const previewContainer = document.getElementById('filePreviewContainer');
            previewContainer.innerHTML = '';

            const alert = document.createElement('div');
            alert.className = 'alert alert-info alert-dismissible fade show d-flex align-items-center gap-3 m-3 mb-0';
            alert.role = 'alert';

            const previewContent = document.createElement('div');
            previewContent.className = 'flex-shrink-0';

            if (file.type.startsWith('image/')) {
                const img = document.createElement('img');
                img.src = URL.createObjectURL(file);
                img.className = 'img-fluid rounded';
                img.style.maxWidth = '150px';
                img.style.maxHeight = '100px';
                img.style.objectFit = 'cover';
                previewContent.appendChild(img);
            } else if (file.type.startsWith('video/')) {
                const video = document.createElement('video');
                video.src = URL.createObjectURL(file);
                video.className = 'rounded';
                video.style.maxWidth = '150px';
                video.style.maxHeight = '100px';
                previewContent.appendChild(video);
            } else {
                const icon = document.createElement('span');
                icon.className = 'file-preview-icon';
                icon.textContent = '';
                previewContent.appendChild(icon);
            }

            alert.appendChild(previewContent);

            const fileName = document.createElement('div');
            fileName.className = 'flex-grow-1 small';
            fileName.textContent = file.name;
            alert.appendChild(fileName);

            const closeBtn = document.createElement('button');
            closeBtn.type = 'button';
            closeBtn.className = 'btn-close';
            closeBtn.setAttribute('aria-label', 'Close');
            closeBtn.onclick = clearFileSelection;
            alert.appendChild(closeBtn);

            previewContainer.appendChild(alert);
        }

        function clearFileSelection() {
            selectedFile = null;
            document.getElementById('fileInput').value = '';
            document.getElementById('filePreviewContainer').innerHTML = '';
        }

        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();

            if (!message && !selectedFile) return;
            if (!currentConversation) return;

            try {
                const formData = new FormData();

                if (message) {
                    formData.append('message', message);
                }

                if (selectedFile) {
                    formData.append('file', selectedFile);
                }

                const response = await fetch(`${API_URL}/conversations/${currentConversation}/messages`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Accept': 'application/json'
                    },
                    body: formData
                });

                if (response.ok) {
                    input.value = '';
                    clearFileSelection();
                    loadMessages();
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }

        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, m => map[m]);
        }

        function logout() {
            if (messageInterval) clearInterval(messageInterval);
            if (sidebarInterval) clearInterval(sidebarInterval);
            localStorage.removeItem('token');
            token = null;
            currentUser = null;
            currentConversation = null;
            currentChatUser = null;
            document.getElementById('loginContainer').style.display = 'flex';
            document.getElementById('loginContainer').classList.remove('d-none');
            document.getElementById('chatContainer').style.display = 'none';
            document.getElementById('chatContainer').classList.add('d-none');
        }
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>
</body>
</html>
